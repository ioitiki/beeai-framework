{"version":3,"sources":["agent.ts"],"names":["RePlanAgent","BaseAgent","emitter","constructor","input","Emitter","root","child","namespace","creator","_run","_options","context","prompt","memory","add","UserMessage","runner","createRunner","finalMessage","undefined","state","run","nextStep","type","message","toolResults","tools","calls","AssistantMessage","RePlanAssistantPrompt","render","results","JSON","stringify","intermediateMemory","UnconstrainedMemory","addMany","messages","schema","createRePlanOutputSchema","response","llm","createStructure","definition","abortSignal","signal","emit","object","Promise","all","map","call","tool","find","name","AgentError","meta","output","Tool","contextKeys","Memory","error"],"mappings":"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","file":"agent.js","sourcesContent":["/**\n * Copyright 2025 Â© BeeAI a Series of LF Projects, LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Callback } from \"@/emitter/types.js\";\nimport { Emitter } from \"@/emitter/emitter.js\";\nimport { AgentError, BaseAgent, BaseAgentRunOptions } from \"@/agents/base.js\";\nimport { GetRunContext } from \"@/context.js\";\nimport { AssistantMessage, Message, UserMessage } from \"@/backend/message.js\";\nimport {\n  createRePlanOutputSchema,\n  RePlanState,\n  RePlanAssistantPrompt,\n} from \"@/agents/experimental/replan/prompts.js\";\nimport { BaseMemory } from \"@/memory/base.js\";\nimport { UnconstrainedMemory } from \"@/memory/unconstrainedMemory.js\";\nimport { AnyTool, Tool } from \"@/tools/base.js\";\nimport { ChatModel } from \"@/backend/chat.js\";\n\nexport interface RePlanRunInput {\n  prompt: string | null;\n}\n\nexport interface RePlanRunOutput {\n  message: Message;\n  intermediateMemory: BaseMemory;\n}\n\nexport interface RePlanToolCall {\n  name: string;\n  input: any;\n}\n\nexport interface RePlanEvents {\n  update: Callback<{ state: RePlanState }>;\n  tool: Callback<\n    | { type: \"start\"; tool: AnyTool; input: any; calls: RePlanToolCall[] }\n    | { type: \"success\"; tool: AnyTool; input: any; output: any; calls: RePlanToolCall[] }\n    | { type: \"error\"; tool: AnyTool; input: any; error: Error; calls: RePlanToolCall[] }\n  >;\n}\n\ninterface Input {\n  memory: BaseMemory;\n  tools: AnyTool[];\n  llm: ChatModel;\n}\n\nexport class RePlanAgent extends BaseAgent<RePlanRunInput, RePlanRunOutput> {\n  public emitter = Emitter.root.child<RePlanEvents>({\n    namespace: [\"agent\", \"rePlan\"],\n    creator: this,\n  });\n\n  constructor(protected readonly input: Input) {\n    super();\n  }\n\n  protected async _run(\n    input: RePlanRunInput,\n    _options: BaseAgentRunOptions,\n    context: GetRunContext<this>,\n  ): Promise<RePlanRunOutput> {\n    if (input.prompt !== null) {\n      await this.memory.add(new UserMessage(input.prompt));\n    }\n\n    const runner = await this.createRunner(context);\n\n    let finalMessage: Message | undefined = undefined;\n    while (!finalMessage) {\n      const state = await runner.run();\n\n      if (state.nextStep.type === \"message\") {\n        finalMessage = new UserMessage(state.nextStep.message);\n      } else if (state.nextStep.type === \"tool\") {\n        const toolResults = await runner.tools(state.nextStep.calls);\n        await runner.memory.add(\n          new AssistantMessage(\n            RePlanAssistantPrompt.render({\n              results: JSON.stringify(toolResults),\n            }),\n          ),\n        );\n      }\n    }\n\n    await this.memory.add(finalMessage);\n\n    return {\n      message: finalMessage,\n      intermediateMemory: runner.memory,\n    };\n  }\n\n  protected async createRunner(context: GetRunContext<this>) {\n    const memory = new UnconstrainedMemory();\n    await memory.addMany(this.memory.messages);\n\n    const run = async (): Promise<RePlanState> => {\n      const schema = await createRePlanOutputSchema(this.input.tools);\n      const response = await this.input.llm.createStructure({\n        schema: schema.definition,\n        abortSignal: context.signal,\n        messages: memory.messages,\n      });\n      await memory.add(new AssistantMessage(JSON.stringify(response)));\n      await context.emitter.emit(\"update\", { state: response.object });\n      return response.object;\n    };\n\n    const tools = async (calls: RePlanToolCall[]) => {\n      return await Promise.all(\n        calls.map(async (call) => {\n          const tool = this.input.tools.find((tool) => tool.name === call.name);\n          if (!tool) {\n            throw new AgentError(`Tool ${call.name} does not exist.`);\n          }\n\n          const meta = { input: call, tool, calls };\n          await context.emitter.emit(\"tool\", { type: \"start\", ...meta });\n          try {\n            const output = await tool.run(call.input, { signal: context.signal }).context({\n              [Tool.contextKeys.Memory]: memory,\n            });\n            await context.emitter.emit(\"tool\", { type: \"success\", ...meta, output });\n            return output;\n          } catch (error) {\n            await context.emitter.emit(\"tool\", { type: \"error\", ...meta, error });\n            throw error;\n          }\n        }),\n      );\n    };\n\n    return {\n      memory,\n      run,\n      tools,\n    };\n  }\n\n  get memory() {\n    return this.input.memory;\n  }\n\n  set memory(memory: BaseMemory) {\n    this.input.memory = memory;\n  }\n}\n"]}